<!-- Template for instructions page -->

<div class="instructions-stim-container">
    <div id="task-intro">
        <h2 class="bolded-blue" data-i18n="study-task-spacial-intro-header"></h2>
        <div id="title-intro-p1">
            <p data-i18n="study-task-spacial-intro-p1"></p>
            <p data-i18n="study-task-spacial-intro-p2"></p>
        </div>
    </div>

    <h2 id="task-counter" class="bolded-blue hidden">
        <span data-i18n="study-task-spacial-header"></span>
        <span id="task-counter-text"></span>
    </h2>

    <h2 id="task-ended" class="bolded-blue hidden" data-i18n="study-task-spacial-header-ended"></h2>

    <div id="mrt-form">
        <img id="mrt-q" src="./img/mrt_stim_transparent.png" class="mrt-stimulus mrt-q0" alt="...">
        <div id="mrt-answers" class="table-responsive">
            <table class="table-borderless" style="margin: auto">
                <tbody>
                    <tr id="task-intro-p2" class="hidden">
                        <td colspan="4">
                            <p class="text-primary" data-i18n="study-task-spacial-intro-p3"></p>
                            <p class="text-primary" data-i18n="study-task-spacial-intro-p4"></p>
                        </td>
                    </tr>
                    <tr id="ai-suggestion" class="hidden">
                        <td colspan="4">
                            <div class="robot-bg message-cloud">
                                <span data-i18n="study-task-spacial-by_ai" class="font-weight-bold"></span>
                                <span data-i18n="study-task-spacial-ai-suggestion1"></span>
                                <span id="ai-choices"></span>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td><img id="mrt-a1" src="./img/mrt_stim_transparent.png" class="mrt-stimulus mrt-q0-a1 border border-3" alt="..."></td>
                        <td><img id="mrt-a2" src="./img/mrt_stim_transparent.png" class="mrt-stimulus mrt-q0-a2 border border-3" alt="..."></td>
                        <td><img id="mrt-a3" src="./img/mrt_stim_transparent.png" class="mrt-stimulus mrt-q0-a3 border border-3" alt="..."></td>
                        <td><img id="mrt-a4" src="./img/mrt_stim_transparent.png" class="mrt-stimulus mrt-q0-a4 border border-3" alt="..."></td>
                    </tr>
                    <tr>
                        <td><button id="btn1" type="button" class="btn btn-primary btn-lg" onclick="addToAnswerSelection(1)">1</button></td>
                        <td><button id="btn2" type="button" class="btn btn-primary btn-lg" onclick="addToAnswerSelection(2)">2</button></td>
                        <td><button id="btn3" type="button" class="btn btn-primary btn-lg" onclick="addToAnswerSelection(3)">3</button></td>
                        <td><button id="btn4" type="button" class="btn btn-primary btn-lg" onclick="addToAnswerSelection(4)">4</button></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <button id="task-submit-button" type="button" class="btn btn-primary btn-lg col-6 mx-auto d-grid disabled" data-i18n="study-task-spacial-suggestion"
                style="margin: 20px" onclick="saveParticipantResponse()"></button>
    </div>
</div>

<script type="text/javascript">
    let available_tasks = [1,2,5,9,10,13,14,15,17,18];
    let tasks = {
        0: [1,2],
        1: [1,3],
        2: [1,4],
        5: [1,3],
        9: [2,4],
        10: [1,4],
        13: [2,4],
        14: [1,4],
        15: [2,4],
        17: [1,3],
        18: [1,4]
    }
    let round = 0;
    let current_task = 0;
    let time_now = Date.now();
    let steps_counter = 1;
    let final_answers = {};
    let current_answer = [];
    let inject_errors_at = [];
    const TASK_SIZE = 5;
    const AI_ERRORS = 2;
    const MAX_ANSWERS = 2;
    const FINAL_STEP = 2;
    const IMG_RESOURCE = './img/MRTStimuli/T{task-id}-{image-id}.jpeg';

    function init() {
        while(inject_errors_at.length<AI_ERRORS){
            let random_round = Math.floor((Math.random()*TASK_SIZE)+1);
            if(!inject_errors_at.includes(random_round)) {
                inject_errors_at.push(random_round)
            }
        }
    }

    function addToAnswerSelection(value){
        let value_position = current_answer.indexOf(value);
        if (value_position === -1) {
            if(current_answer.length === MAX_ANSWERS) {
                current_answer = [];
            }
            current_answer.push(value);
        } else {
            current_answer.splice(value_position, 1);
        }
        updateSelection();
    }

    function updateSelection(){
        for(let option of [1,2,3,4]) {
            if(current_answer.indexOf(option) === -1){
                $(`#btn${option}`).removeClass('active');
                $(`#mrt-a${option}`).removeClass('border-primary');
            } else {
                $(`#btn${option}`).addClass('active');
                $(`#mrt-a${option}`).addClass('border-primary');
            }
        }
        if(current_answer.length === MAX_ANSWERS) {
            $('#task-submit-button').removeClass('disabled');
        } else {
            $('#task-submit-button').addClass('disabled');
        }
    }

    function isResponseCorrect(response_array, question_number){
        return JSON.stringify(response_array.sort())===JSON.stringify(tasks[question_number]);
    }

    function saveParticipantResponse() {
        saveResponse(`H${steps_counter}`, current_task, round, current_answer, isResponseCorrect(current_answer, current_task));
        updateInterface();
    }

    function saveResponse(response_code, task_id, round_count, response_array, is_response_correct) {
        final_answers[`R${round_count}_${response_code}`] = {
            answer: JSON.parse(JSON.stringify(response_array)),
            task: task_id,
            round: round_count,
            correct: is_response_correct,
            time: Date.now()-time_now
        };
    }

    function updateInterface() {
        steps_counter += steps_counter;

        if(steps_counter===2) {
            $('#task-submit-button').text($.i18n('study-task-spacial-submit'));
            let ai_suggestion = generateAISuggestion().sort();
            saveResponse('AI', current_task, round, ai_suggestion, isResponseCorrect(ai_suggestion, current_task));
            $('#ai-choices').text(JSON.stringify(ai_suggestion));
            $('#ai-suggestion').show();
            if(round===0) {
                $('#task-intro-p2').show();
            }
        }
        if(steps_counter > FINAL_STEP) {
            resetInterface();
        }
        time_now = Date.now();
    }

    function generateAISuggestion() {
        let ai_answer = JSON.parse(JSON.stringify(tasks[current_task]));
        if(round>0 && inject_errors_at.includes(round)) {
            let possible_answers = [1,2,3,4];
            let need_to_mess_up = true;
            while(possible_answers.length>0 && need_to_mess_up){
                let messed_up_answer = possible_answers.splice(Math.floor(Math.random()*possible_answers.length), 1)[0];
                if(!ai_answer.includes(messed_up_answer)) {
                    ai_answer[Math.floor(Math.random()*ai_answer.length)] = messed_up_answer;
                    need_to_mess_up = false;
                }
            }
        }
        return ai_answer;
    }

    function resetInterface() {
        steps_counter = 1;
        round += 1;
        current_answer = [];

        $('#task-counter-text').text(`${round}/${TASK_SIZE}`);
        $('#ai-suggestion').hide();
        $('#task-submit-button')
            .addClass('disabled')
            .text($.i18n('study-task-spacial-suggestion'));

        if(round === 1){
            $('#task-intro').hide();
            $('#task-intro-p2').hide();
            $('#task-counter').show();
        }

        if(round <= TASK_SIZE) {
            let previous_task = current_task;
            current_task = available_tasks.splice(Math.floor(Math.random()*available_tasks.length), 1)[0];
            $('#mrt-q')
                .removeClass(`mrt-q${previous_task}`)
                .addClass(`mrt-q${current_task}`);
            for(let counter=1; counter<=4; counter++) {
                $(`#mrt-a${counter}`)
                    .removeClass('border-primary')
                    .removeClass(`mrt-q${previous_task}-a${counter}`)
                    .addClass(`mrt-q${current_task}-a${counter}`);
                $(`#btn${counter}`).removeClass('active').removeClass('disabled');
            }
        } else {
            LITW.study.params.task_answers = final_answers;
//            $('#task-counter').hide();
//            $('#mrt-form').hide();
//            $('#task-ended').show();
//            $('#btn-next-page').show();
            $('#btn-next-page').click();
        }
    }

    $(document).ready(function() {
        init()
    });
</script>